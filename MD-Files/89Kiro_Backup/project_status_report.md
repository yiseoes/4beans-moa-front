# 프로젝트 상세 현황 리포트

## 1. 개요
본 리포트는 현재 구현된 백엔드 시스템의 핵심 모듈인 **파티(Party), 결제(Payment), 정산(Settlement), 보증금(Deposit)**의 상태, 로직, 수정 내역 및 향후 계획을 상세히 기술합니다.

---

## 2. 모듈별 상세 분석

### 2.1. 파티 (Party)
**현재 상태**: ✅ 구현 완료 (v1.0 기준)

**핵심 로직**:
1. **파티 생성**: 사용자가 파티를 생성하면 초기 상태는 `PENDING_PAYMENT`입니다.
2. **방장 보증금 결제**: 방장이 보증금(월 구독료 100%)을 결제하면 파티 상태가 `RECRUITING`으로 변경됩니다.
3. **파티원 가입**:
    - 파티원이 가입 시 **보증금**과 **첫 달 구독료**를 동시에 결제합니다.
    - 결제 성공 시 파티원 상태는 `ACTIVE`가 됩니다.
    - 파티 인원이 꽉 차면 파티 상태가 `ACTIVE`로 자동 전환됩니다.

**수정/특이 사항**:
- **탈퇴 기능 미지원**: v1.0에서는 파티 탈퇴(`leaveParty`) 기능이 비활성화되어 있습니다 (`FEATURE_NOT_AVAILABLE` 예외 발생).
- **상품 정보**: 상품 정보가 없을 경우 더미 데이터를 사용하는 임시 로직이 포함되어 있습니다.

**다음 단계**:
- [ ] 파티 탈퇴 및 중도 해지 로직 구현 (v2.0)
- [ ] 상품(Product) 모듈과의 정식 연동

---

### 2.2. 결제 (Payment)
**현재 상태**: ⚠️ 부분 구현 (초기 결제 완료, 자동 결제 미완성)

**핵심 로직**:
1. **초기 결제 (Initial Payment)**:
    - Toss Payments API를 통해 결제 승인을 요청합니다.
    - 성공 시 DB에 결제 정보를 저장하고 파티원 상태를 `ACTIVE`로 변경합니다.
2. **월별 자동 결제 (Monthly Payment)**:
    - 매월 정해진 날짜에 실행되는 로직입니다.
    - 현재는 DB에 결제 내역(`Payment`)을 생성하는 로직만 구현되어 있습니다.

**수정/특이 사항**:
- **자동 결제 API 미연동**: `createMonthlyPayment` 메서드 내에 Toss Payments 빌링키를 이용한 실제 결제 승인 요청 로직이 주석 처리(TODO)되어 있습니다. 현재는 결제 데이터만 생성됩니다.

**다음 단계**:
- [ ] Toss Payments 빌링키 발급 및 자동 결제 API 연동 (v2.0)
- [ ] 결제 실패 시 재시도(Retry) 로직 구현

---

### 2.3. 정산 (Settlement)
**현재 상태**: ✅ 구현 완료

**핵심 로직**:
1. **월별 정산 스케줄러**: 매월 1일 새벽 4시에 `SettlementScheduler`가 실행됩니다.
2. **정산 생성**:
    - 전월 결제 내역(`COMPLETED`)을 집계합니다.
    - **수수료 15%**를 제외한 순 정산액(`netAmount`)을 계산합니다.
3. **자동 이체**: 오픈뱅킹 API(`OpenBankingService`)를 호출하여 방장 계좌로 즉시 입금 처리합니다.
4. **알림 발송**: 정산 완료 시 `SettlementCompletedEvent`를 발행하여 방장에게 알림을 보냅니다.

**수정/특이 사항**:
- **완전 자동화**: 정산 생성부터 이체까지 한 번에 처리되는 Full Automation 구조입니다.

**다음 단계**:
- [ ] 정산 실패 시 수동 처리(Retry)를 위한 관리자 기능
- [ ] 오픈뱅킹 API 연동 테스트 (실제 은행 망 연동 검증)

---

### 2.4. 보증금 (Deposit)
**현재 상태**: ✅ 구현 완료

**핵심 로직**:
1. **보증금 결제**: 파티 생성(방장) 또는 가입(파티원) 시 결제됩니다. 상태는 `PAID`가 됩니다.
2. **환불 (Refund)**:
    - 파티 종료 또는 해지 시 `refundDeposit` 메서드가 호출됩니다.
    - Toss Payments 결제 취소 API를 호출하여 전액 환불합니다.
    - 환불 완료 시 `RefundCompletedEvent`를 발행하여 사용자에게 알림을 보냅니다.

**수정/특이 사항**:
- **전액 환불**: v1.0 정책상 차감 없이 전액 환불만 지원합니다.

**다음 단계**:
- [ ] 파티 중도 해지 시 위약금 차감 후 환불 로직 (v2.0)

---

## 3. 종합 및 향후 코딩 계획

### 우선순위 작업 (Immediate Tasks)
1. **테스트 커버리지 확보**:
    - `SettlementScheduler`의 이벤트 발행 테스트 추가
    - `DepositServiceImpl`의 환불 이벤트 발행 테스트 추가
    - (이미 계획된 작업입니다)

### 중장기 과제 (Future Tasks)
1. **자동 결제 완성**: 월별 자동 결제 시 실제 과금이 되도록 Toss Billing API 연동.
2. **예외 처리 강화**: 결제/정산 실패 시 롤백 및 재시도 메커니즘 고도화.
3. **관리자 기능**: 정산 내역 조회 및 수동 정산 처리 기능.
